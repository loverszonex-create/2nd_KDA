<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì£¼ì£¼í´ëŸ½ Â· í‚¤ìš°Me</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body data-macro-interval="300000" data-mood-interval="60000">
    <div class="app-frame" id="app-frame">
      <div class="status-bar">
        <div class="status-bar__left">
          <span id="status-time">--:--</span>
          <span class="status-loc">â›¯</span>
        </div>
        <div class="status-bar__icons">
          <span class="icon-signal"></span>
          <span class="icon-wifi"></span>
          <span class="icon-battery" id="status-battery"></span>
        </div>
      </div>

      <header class="top-bar" id="top-bar"></header>

      <main class="app-main">
        <!-- HOME -->
        <section id="page-home" class="page active">
          <div class="home-hero">
            <div class="home-robot" aria-hidden="true">ğŸ¤–</div>
            <div class="home-hero__inner">
              <div class="home-hero__badge" id="home-temperature-pill">
                <span class="emoji" id="home-temperature-emoji">ğŸ™‚âšª</span>
                <span id="home-temperature-text">ì˜¤ëŠ˜ì˜ ì˜¨ë„ ë¡œë”© ì¤‘...</span>
              </div>
              <h1 class="home-hero__title">ì¢…ëª©ê³¼ ëŒ€í™”í•˜ê¸°, í‚¤ìš°Me</h1>
              <p class="home-hero__subtitle">
                ë‹¹ì‹ ì˜ ê´€ì‹¬ ì¢…ëª©ê³¼ ëŒ€í™”í•˜ë©° ì‹œì¥ì„ ì´í•´í•˜ì„¸ìš”.
              </p>
            </div>

            <div class="home-search">
              <form id="home-search-form" class="home-search__form">
                <div class="home-search__inner">
                  <input
                    type="text"
                    id="home-search-input"
                    class="home-search__input"
                    placeholder="í‚¤ìš°Meì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”"
                    autocomplete="off"
                  />
                  <button type="submit" class="home-search__button" aria-label="ê²€ìƒ‰">
                    â¤
                  </button>
                </div>
              </form>
            </div>
          </div>

          <div class="home-tabs">
            <button class="home-tab active" data-home-tab="home">í™ˆ</button>
            <button class="home-tab" data-home-tab="all">ì „ì²´ë³´ê¸°</button>
            <button class="home-tab" data-home-tab="bookmark">ë¶ë§ˆí¬</button>
          </div>

          <div class="page-scroller">
            <section class="home-section">
              <div class="home-hint" id="home-hint">
                ì˜¤ëŠ˜ì€ ì–´ë–¤ ì¢…ëª©ê³¼ ëŒ€í™”í• ê¹Œìš”?
                <span>í„°ì¹˜ í•œ ë²ˆì´ë©´ ì‹¤ì‹œê°„ ë¦¬ì„œì¹˜ì™€ ê°ì • ë¦¬í¬íŠ¸ë¥¼ ë°›ì•„ë³¼ ìˆ˜ ìˆì–´ìš”.</span>
              </div>
              <div class="stock-list" id="home-stock-list"></div>
              <div class="bookmark-empty hidden" id="home-bookmark-empty">
                ì €ì¥ëœ ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br />ì±„íŒ…ì—ì„œ ì¤‘ìš”í•œ ë©”ì‹œì§€ë¥¼ ë¶ë§ˆí¬í•´ë³´ì„¸ìš”.
              </div>
            </section>
          </div>
        </section>

        <!-- CHAT -->
        <section id="page-chat" class="page">
          <div class="chat-hero">
            <div class="chat-hero__title" id="chat-hero-title">ì‚¼ì„±ì „ì í‚¤ìš°Me</div>
            <p class="chat-hero__summary" id="chat-hero-summary">
              í•œêµ­íˆ¬ìì¦ê¶Œ ë°ì´í„°ì™€ RAG ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹¤ì‹œê°„ ëŒ€í™”ë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤.
            </p>
            <div class="chat-hero__pill" id="chat-hero-mood-pill">
              <span id="chat-hero-mood-emoji">ğŸ™‚âšª</span>
              <span id="chat-hero-mood-text">ì‹œì¥ ê°ì • íŒŒì•… ì¤‘...</span>
            </div>
            <div class="chat-hero__quick" id="chat-quick-list"></div>
          </div>

          <div class="macro-strip">
            <div class="macro-panel is-loading" data-role="macro-panel">
              <div class="macro-temp">
                <span class="macro-temp__label" data-field="macro-label">â³</span>
                <span class="macro-temp__score" data-field="macro-score">--</span>
              </div>
              <div>
                <p class="macro-desc" data-field="macro-desc">
                  ì‹œì¥ ì²´ê° ì˜¨ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </p>
                <div class="macro-meta">
                  <div>
                    <strong>ì§€ìˆ˜ ë³€ë™</strong>
                    <span data-field="macro-index">-</span>
                  </div>
                  <div>
                    <strong>ADR ë¹„ìœ¨</strong>
                    <span data-field="macro-adr">-</span>
                  </div>
                  <div>
                    <strong>ê±°ë˜ëŸ‰ ë¹„ìœ¨</strong>
                    <span data-field="macro-volume">-</span>
                  </div>
                  <div>
                    <strong>CNN FGI</strong>
                    <span data-field="macro-fgi">-</span>
                  </div>
                  <div>
                    <strong>VKOSPI</strong>
                    <span data-field="macro-vkospi">-</span>
                  </div>
                </div>
              </div>
              <div class="macro-updated" data-field="macro-updated">--</div>
            </div>
          </div>

          <div class="chat-body">
            <div class="chat-messages" id="chat-messages"></div>
            <form class="chat-form" id="chat-form">
              <label for="chat-input" class="sr-only">ì§ˆë¬¸ ì…ë ¥</label>
              <textarea
                id="chat-input"
                class="chat-input"
                placeholder="í‚¤ìš°Meì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”"
                required
              ></textarea>
              <div class="chat-controls">
                <label class="toggle">
                  <input type="checkbox" id="chat-stream-toggle" checked />
                  ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ
                </label>
                <button type="submit" class="chat-submit">ì „ì†¡</button>
              </div>
              <input type="hidden" id="chat-ticker" value="005930.KS" />
            </form>
          </div>
        </section>

        <!-- DASHBOARD -->
        <section id="page-dashboard" class="page">
          <div class="page-wrapper">
            <div class="panel">
              <div class="panel__title">ë‚˜ì˜ íˆ¬ì í˜ë¥´ì†Œë‚˜</div>
              <div class="stats-grid" id="dashboard-level-stats">
                <!-- Filled via JS -->
              </div>
            </div>
            <div class="panel">
              <div class="panel__title">ìµœê·¼ í™œë™ ìš”ì•½</div>
              <div class="timeline" id="dashboard-timeline"></div>
            </div>
          </div>
        </section>

        <!-- WEEKLY REPORT -->
        <section id="page-weekly" class="page">
          <div class="page-wrapper">
            <div class="panel">
              <div class="panel__title">ì´ë²ˆ ì£¼ ì£¼ê°„ ë¦¬í¬íŠ¸</div>
              <div class="stats-grid" id="weekly-stat-grid"></div>
            </div>
            <div class="panel">
              <div class="panel__title">í•˜ì´ë¼ì´íŠ¸</div>
              <div class="timeline" id="weekly-highlight"></div>
            </div>
          </div>
        </section>

        <!-- BOOKMARKS -->
        <section id="page-bookmarks" class="page">
          <div class="page-wrapper">
            <div class="panel">
              <div class="panel__title">ì €ì¥ëœ ëŒ€í™”</div>
              <div class="bookmark-list" id="bookmark-page-list"></div>
              <div class="bookmark-empty hidden" id="bookmark-page-empty">
                ì €ì¥ëœ ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤.
              </div>
            </div>
          </div>
        </section>

        <!-- PROFILE -->
        <section id="page-profile" class="page">
          <div class="page-wrapper">
            <div class="panel profile-card" id="profile-card">
              <div class="profile-avatar" id="profile-avatar">ME</div>
              <div>
                <div class="profile-name" id="profile-name">í‚¤ìš°Me íšŒì›</div>
                <div class="profile-meta" id="profile-meta">
                  ê°€ì…ì¼ Â· ë ˆë²¨ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </div>
              </div>
              <div class="stats-grid" id="profile-stats"></div>
              <button class="primary-button" id="profile-edit-btn">í”„ë¡œí•„ í¸ì§‘</button>
            </div>
            <div class="panel">
              <div class="panel__title">ìµœê·¼ ì‚¬ìš© ê¸°ë¡</div>
              <div class="list-compact" id="profile-activity"></div>
            </div>
          </div>
        </section>
      </main>

      <nav class="app-nav" id="app-nav">
        <button class="nav-item active" data-nav="home">
          <span class="nav-icon">ğŸ </span>
          <span>í™ˆ</span>
        </button>
        <button class="nav-item" data-nav="chat">
          <span class="nav-icon">ğŸ’¬</span>
          <span>ì±„íŒ…</span>
        </button>
        <button class="nav-item" data-nav="dashboard">
          <span class="nav-icon">ğŸ“Š</span>
          <span>ëŒ€ì‹œë³´ë“œ</span>
        </button>
        <button class="nav-item" data-nav="weekly">
          <span class="nav-icon">ğŸ—“ï¸</span>
          <span>ì£¼ê°„</span>
        </button>
        <button class="nav-item" data-nav="profile">
          <span class="nav-icon">ğŸ‘¤</span>
          <span>í”„ë¡œí•„</span>
        </button>
      </nav>
    </div>

    <script type="module" src="app.js"></script>
  </body>
</html>

    @media (max-width: 720px) {
      .macro-panel {
        grid-template-columns: 1fr;
        align-items: flex-start;
      }

      .macro-temp {
        flex-direction: row;
        justify-content: flex-start;
        gap: 12px;
      }

      .macro-temp-score {
        font-size: 1.1rem;
      }
    }

    .chat-window {
      flex: 1;
      overflow-y: auto;
      padding: 24px 32px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .message {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 78%;
      animation: fadeIn 0.35s ease;
    }

    .message.user { align-self: flex-end; }
    .message.ai { align-self: flex-start; }

    .bubble {
      padding: 16px 18px;
      border-radius: 16px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .message.user .bubble {
      background: var(--bubble-user);
      color: #0f172a;
      font-weight: 600;
    }

    .message.ai .bubble {
      background: var(--bubble-ai);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .message-meta {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .sources {
      margin: 12px 0 0;
      padding-left: 18px;
      font-size: 0.9rem;
      color: rgba(148, 197, 255, 0.9);
    }

    .sources li + li { margin-top: 4px; }

    .sources a {
      color: #7dd3fc;
      text-decoration: none;
    }

    .sources a:hover { text-decoration: underline; }

    form {
      border-top: 1px solid rgba(148, 163, 184, 0.12);
      padding: 20px 24px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: center;
      background: rgba(15, 23, 42, 0.9);
    }

    textarea {
      width: 100%;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px;
      padding: 16px;
      min-height: 92px;
      font-size: 1rem;
      color: var(--text);
      resize: vertical;
    }

    textarea:focus {
      outline: 2px solid rgba(56, 189, 248, 0.45);
      outline-offset: 2px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-end;
    }

    .controls button {
      padding: 14px 28px;
      border: none;
      border-radius: 14px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #0f172a;
      box-shadow: 0 18px 30px rgba(56, 189, 248, 0.25);
    }

    .controls button:disabled {
      background: rgba(148, 163, 184, 0.4);
      color: rgba(15, 23, 42, 0.6);
      box-shadow: none;
      cursor: not-allowed;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .toggle input {
      accent-color: #38bdf8;
      transform: scale(1.2);
    }
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 720px) {
      main { height: 95vh; }
      .message { max-width: 88%; }
      form { grid-template-columns: 1fr; }
      .controls { align-items: stretch; }
    }

    .visuals {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .visuals canvas {
      width: 100% !important;
      max-width: 100%;
      height: auto !important;
      border-radius: 0;
      background: none;
      padding: 0;
    }

    .visuals.hidden {
      display: none;
    }

    .snapshot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .snapshot-card {
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 14px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .snapshot-card h4 {
      margin: 0;
      font-size: 1rem;
    }

    .snapshot-metric {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .snapshot-sub {
      font-size: 0.85rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>ğŸ“ˆ ì‚¼ì„±ì „ì í˜ë¥´ì†Œë‚˜ì™€ ëŒ€í™”í•˜ê¸°</h1>
      <p>í•œêµ­íˆ¬ìì¦ê¶Œ ì‹¤ì‹œê°„ ë°ì´í„°ì™€ RAG ë¬¸ì„œë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì‚¼ì„±ì „ì ìŠ¤ìŠ¤ë¡œê°€ í˜„ì¬ ê¸°ë¶„ê³¼ ìƒí™©ì„ ì´ì•¼ê¸°í•©ë‹ˆë‹¤.</p>
      <div class="quick-asks" role="list" aria-label="ì˜ˆì‹œ ì§ˆë¬¸">
        <button type="button" data-question="ì˜¤ëŠ˜ ê¸°ë¶„ì´ ì¢‹ì€ ì´ìœ ë¥¼ ê°„ë‹¨íˆ ë§í•´ì¤„ë˜?">ì˜¤ëŠ˜ ë¶„ìœ„ê¸° ì–´ë•Œ?</button>
        <button type="button" data-question="ìµœê·¼ ë‰´ìŠ¤ ì¤‘ì—ì„œ ê¼­ ì•Œì•„ì•¼ í•  ì´ìŠˆë¥¼ ì•Œë ¤ì¤˜">ìµœê·¼ ë‰´ìŠ¤ ìš”ì•½í•´ì¤˜</button>
        <button type="button" data-question="ë‚´ ì£¼ê°€ íë¦„ì„ KOSPIì™€ ë¹„êµí•´ì„œ ì§§ê²Œ ë¶„ì„í•´ì¤˜">KOSPIë‘ ë¹„êµ ë¶„ì„í•´ì¤˜</button>
      </div>
      <div class="mood-pill" id="header-mood">ğŸ˜ í˜„ì¬ ê°ì • íŒŒì•… ì¤‘...</div>
      <section class="macro-panel macro-panel--loading" id="macro-panel" aria-live="polite">
        <div class="macro-temp">
          <span class="macro-temp-label" id="macro-label">â³</span>
          <span class="macro-temp-score" id="macro-score">--</span>
        </div>
        <div class="macro-details">
          <p class="macro-desc" id="macro-desc">ì‹œì¥ ì²´ê° ì˜¨ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          <dl class="macro-components">
            <div>
              <dt>ì§€ìˆ˜ ë³€ë™</dt>
              <dd id="macro-index">-</dd>
            </div>
            <div>
              <dt>ADR ë¹„ìœ¨</dt>
              <dd id="macro-adr">-</dd>
            </div>
            <div>
              <dt>ê±°ë˜ëŸ‰ ë¹„ìœ¨</dt>
              <dd id="macro-volume">-</dd>
            </div>
            <div>
              <dt>CNN FGI</dt>
              <dd id="macro-fgi">-</dd>
            </div>
            <div>
              <dt>VKOSPI</dt>
              <dd id="macro-vkospi">-</dd>
            </div>
          </dl>
        </div>
        <small class="macro-updated" id="macro-updated">--</small>
      </section>
    </header>

    <section class="chat-window" id="messages"></section>

    <form id="chat-form" role="form">
      <label class="visually-hidden" for="chat-question">ì§ˆë¬¸ ì…ë ¥</label>
      <textarea id="chat-question" name="question" aria-label="ì§ˆë¬¸ ì…ë ¥" placeholder="ë¬´ì—‡ì´ ê¶ê¸ˆí•œê°€ìš”? ì˜ˆ) ì‚¼ì„±ì „ìì•¼ ìµœê·¼ ì‹¤ì  ì–´ë•Œ?" required></textarea>
      <div class="controls">
        <div class="toggle" role="group" aria-label="ìŠ¤íŠ¸ë¦¬ë° ì„¤ì •">
          <input type="checkbox" id="toggle-stream" name="stream" checked aria-checked="true" />
          <label for="toggle-stream">ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ</label>
        </div>
        <button type="submit">ì „ì†¡</button>
      </div>
      <input type="hidden" id="chat-ticker" name="ticker" value="005930.KS" />
    </form>
  </main>

  <script type="module">
    const loadChart = (() => {
      let promise;
      return () => {
        if (window.Chart) return Promise.resolve(window.Chart);
        if (!promise) {
          promise = new Promise((resolve) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js';
            script.async = true;
            script.onload = () => resolve(window.Chart || null);
            script.onerror = () => resolve(null);
            document.head.appendChild(script);
          });
        }
        return promise;
      };
    })();

    // ì™¸ë¶€(MCP ë“±) content scriptê°€ í¼ ìš”ì†Œì— ì ‘ê·¼í•˜ë©° ë°œìƒí•˜ëŠ” ì˜ˆì™¸ë¥¼ ì°¨ë‹¨
    const suppressCursorScripts = (event) => {
      if (event.target?.closest?.('#chat-form')) {
        event.stopImmediatePropagation();
      }
    };
    window.addEventListener('focusin', suppressCursorScripts, true);
    window.addEventListener('input', suppressCursorScripts, true);
    window.addEventListener('error', (event) => {
      const msg = event?.message || '';
      if (msg.includes("reading 'control'") || msg.includes('hostname check')) {
        event.preventDefault();
        event.stopImmediatePropagation();
      }
    }, true);
    window.addEventListener('unhandledrejection', (event) => {
      const msg = event?.reason?.message || '';
      if (msg.includes("reading 'control'")) {
        event.preventDefault();
        event.stopImmediatePropagation();
      }
    }, true);

    const form = document.getElementById('chat-form');
    const textarea = form.querySelector('textarea');
    const messages = document.getElementById('messages');
    const headerMood = document.getElementById('header-mood');
    const macroPanel = document.getElementById('macro-panel');
    const macroLabelEl = document.getElementById('macro-label');
    const macroScoreEl = document.getElementById('macro-score');
    const macroDescEl = document.getElementById('macro-desc');
    const macroIndexEl = document.getElementById('macro-index');
    const macroAdrEl = document.getElementById('macro-adr');
    const macroVolumeEl = document.getElementById('macro-volume');
    const macroFgiEl = document.getElementById('macro-fgi');
    const macroVkospiEl = document.getElementById('macro-vkospi');
    const macroUpdatedEl = document.getElementById('macro-updated');

    const moodDescriptions = {
      'ğŸ˜„ ë§¤ìš° ê¸°ì¨': 'ğŸ˜„ ë§¤ìš° ê¸°ì¨ Â· ì‹œì¥ ëŒ€ë¹„ ê°•ì„¸',
      'ğŸ™‚ ê¸°ì¨': 'ğŸ™‚ ê¸°ì¨ Â· ì‹œì¥ê³¼ í•¨ê»˜ ìƒìŠ¹',
      'ğŸ˜ ë³´í†µ': 'ğŸ˜ ë³´í†µ Â· ì°¨ë¶„í•œ í•˜ë£¨',
      'â˜¹ï¸ ìŠ¬í””': 'â˜¹ï¸ ìŠ¬í”” Â· ê¸°ëŒ€ì— ëª» ë¯¸ì¹œ íë¦„',
      'ğŸ˜­ ë§¤ìš° ìŠ¬í””': 'ğŸ˜­ ë§¤ìš° ìŠ¬í”” Â· ì‹œì¥ ëŒ€ë¹„ ì•½ì„¸'
    };

    const formatNumber = (value) => {
      if (value === null || value === undefined) return 'N/A';
      const num = Number(value);
      if (Number.isNaN(num)) return 'N/A';
      return new Intl.NumberFormat('ko-KR').format(num);
    };

    const formatPlain = (value) => {
      if (value === null || value === undefined) return 'N/A';
      const num = Number(value);
      if (Number.isNaN(num)) return 'N/A';
      const fixed = Math.abs(num) >= 1 ? num.toFixed(2) : num.toFixed(4);
      return Number.parseFloat(fixed).toString();
    };

    const formatPercent = (value) => {
      if (value === null || value === undefined) return 'N/A';
      const num = Number(value);
      if (Number.isNaN(num)) return 'N/A';
      return `${num >= 0 ? '+' : ''}${num.toFixed(2)}%`;
    };

    const formatPercentAbs = (value) => {
      if (value === null || value === undefined) return 'N/A';
      const num = Number(value);
      if (Number.isNaN(num)) return 'N/A';
      return `${num.toFixed(2)}%`;
    };

    const formatAsOf = (isoString) => {
      if (!isoString) return '';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return '';
      const options = { timeZone: 'Asia/Seoul', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true };
      const formatted = new Intl.DateTimeFormat('ko-KR', options).format(date);
      const match = formatted.match(/(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2}):(\d{2})/);
      if (!match) return formatted;
      const [, ampm, hour, minute, second] = match;
      const pad = (v) => v.toString().padStart(2, '0');
      return `${ampm} ${pad(hour)}:${minute}:${second}`;
    };

    const MACRO_REFRESH_MS = Number.parseInt(document.body.dataset?.macroInterval ?? '', 10) || 300000;
    let macroTimer = null;
    let macroLastPayload = null;

    const MOOD_REFRESH_MS = Number.parseInt(document.body.dataset?.moodInterval ?? '', 10) || 60000;
    let moodTimer = null;
    let initialMoodRendered = false;

    const scheduleMacroRefresh = (delay = MACRO_REFRESH_MS) => {
      if (macroTimer) clearTimeout(macroTimer);
      const jitter = Math.floor(Math.random() * 15000);
      macroTimer = setTimeout(() => loadMacroWeather(), delay + jitter);
    };

    const scheduleMoodRefresh = (delay = MOOD_REFRESH_MS) => {
      if (moodTimer) clearTimeout(moodTimer);
      const jitter = Math.floor(Math.random() * 10000);
      moodTimer = setTimeout(() => loadMoodSnapshot(), delay + jitter);
    };

    const updateMacroPanel = (payload, { loading = false, error = null } = {}) => {
      if (loading) {
        macroPanel?.classList.add('macro-panel--loading');
        macroLabelEl.textContent = 'â³';
        macroScoreEl.textContent = '--';
        macroDescEl.textContent = 'ì‹œì¥ ì²´ê° ì˜¨ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        macroIndexEl.textContent = macroAdrEl.textContent = macroVolumeEl.textContent = macroFgiEl.textContent = macroVkospiEl.textContent = '-';
        macroUpdatedEl.textContent = '--';
        return;
      }

      macroPanel?.classList.remove('macro-panel--loading');

      if (!payload || !payload.ok || !Number.isFinite(payload.score)) {
        macroLabelEl.textContent = 'âš ï¸';
        macroScoreEl.textContent = '--';
        macroDescEl.textContent = error || payload?.message || 'ì‹œì¥ ê¸°ì˜¨ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš”.';
        macroIndexEl.textContent = macroAdrEl.textContent = macroVolumeEl.textContent = macroFgiEl.textContent = macroVkospiEl.textContent = '-';
        macroUpdatedEl.textContent = '--';
        return;
      }

      macroLastPayload = payload;

      macroLabelEl.textContent = payload.label || 'ğŸ™‚âšª';
      macroScoreEl.textContent = `${payload.score}ì `;
      macroDescEl.textContent = payload.description || 'ì‹œì¥ ë¶„ìœ„ê¸° ìš”ì•½ì´ ì¤€ë¹„ëì–´ìš”.';

      const inputs = payload.inputs || {};
      macroIndexEl.textContent = Number.isFinite(inputs.indexChange)
        ? `${inputs.indexChange >= 0 ? '+' : ''}${inputs.indexChange.toFixed(2)}%`
        : 'N/A';
      macroAdrEl.textContent = Number.isFinite(inputs.adrPercent) ? formatPercentAbs(inputs.adrPercent) : 'N/A';
      macroVolumeEl.textContent = Number.isFinite(inputs.volumePercent) ? formatPercentAbs(inputs.volumePercent) : 'N/A';
      macroFgiEl.textContent = Number.isFinite(inputs.cnnFgi) ? inputs.cnnFgi.toFixed(1) : 'N/A';
      macroVkospiEl.textContent = Number.isFinite(inputs.vkospi) ? inputs.vkospi.toFixed(2) : 'N/A';
      macroUpdatedEl.textContent = payload.fetchedAt ? `ê¸°ì¤€ ${formatAsOf(payload.fetchedAt)}` : '--';
    };

    const loadMacroWeather = async () => {
      if (!macroLastPayload) updateMacroPanel(null, { loading: true });
      try {
        const resp = await fetch('/diag-weather');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        updateMacroPanel(data);
      } catch (err) {
        console.error('[macro] load error', err);
        updateMacroPanel(null, { error: 'ì‹œì¥ ê¸°ì˜¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.' });
      } finally {
        scheduleMacroRefresh();
      }
    };

    const renderMoodOverview = (payload) => {
      if (!payload?.ok || !payload.mood) return;
      setMood(payload.mood);

      if (initialMoodRendered) return;

      initialMoodRendered = true;
      const stock = payload.stock || {};
      const benchmark = payload.benchmark || {};
      const summaryParts = [`ì•ˆë…•í•˜ì„¸ìš”! ì§€ê¸ˆì€ ${payload.mood} ìƒíƒœì˜ˆìš”.`];

      if (Number.isFinite(stock.last_price)) {
        summaryParts.push(`ë‚´ ì£¼ê°€ëŠ” ${formatNumber(stock.last_price)}ì›ì´ê³  ${formatPercent(stock.pct_change)} íë¦„ì´ì—ìš”.`);
      }
      if (Number.isFinite(benchmark.last_price)) {
        summaryParts.push(`KOSPIëŠ” ${formatPlain(benchmark.last_price)}ë¡œ ${formatPercent(benchmark.pct_change)} ì›€ì§ì´ê³  ìˆì–´ìš”.`);
      }

      const intro = createMessage('ai', {
        text: summaryParts.join('\n'),
        mood: payload.mood,
        asOf: stock.ts || benchmark.ts
      });

      intro.renderVisuals({
        snapshot: {
          price: {
            type: 'stock',
            last: stock.last_price,
            change: stock.pct_change,
            volume: stock.volume,
            asOf: stock.ts
          },
          benchmark: {
            type: 'index',
            last: benchmark.last_price,
            change: benchmark.pct_change,
            asOf: benchmark.ts
          }
        }
      });
    };

    const loadMoodSnapshot = async () => {
      try {
        const resp = await fetch('/diag-mood');
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        if (data?.ok) {
          renderMoodOverview(data);
        }
      } catch (err) {
        console.error('[mood] load error', err);
      } finally {
        scheduleMoodRefresh();
      }
    };

    const waitForChart = async () => {
      const chart = await loadChart();
      return chart;
    };

    function createSnapshotCard(title, data) {
      const card = document.createElement('div');
      card.className = 'snapshot-card';

      const heading = document.createElement('h4');
      heading.textContent = title;

      const isIndex = data?.type === 'index' || /KOSPI/i.test(title);

      const metric = document.createElement('div');
      metric.className = 'snapshot-metric';
      metric.textContent = isIndex ? formatPlain(data.last) : `${formatNumber(data.last)}ì›`;

      const sub = document.createElement('div');
      sub.className = 'snapshot-sub';
      const parts = [];
      if (data.change !== undefined && data.change !== null) parts.push(formatPercent(data.change));
      if (!isIndex && data.volume) parts.push(`ê±°ë˜ëŸ‰ ${formatNumber(data.volume)}`);
      if (data.asOf) {
        const pretty = formatAsOf(data.asOf);
        if (pretty) parts.push(`ê¸°ì¤€ ì‹œê° ${pretty}`);
      }
      sub.textContent = parts.join(' Â· ');

      card.append(heading, metric, sub);
      return card;
    }

    function setMood(mood) {
      headerMood.textContent = moodDescriptions[mood] || 'ğŸ˜ í˜„ì¬ ê°ì • íŒŒì•… ì¤‘...';
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
      });
    }

    function createMessage(role, { text = '', mood, asOf } = {}) {
      const wrapper = document.createElement('div');
      wrapper.className = `message ${role}`;

      const header = document.createElement('div');
      header.className = 'message-header';

      if (role === 'ai') {
        const moodSpan = document.createElement('span');
        moodSpan.textContent = mood || 'ğŸ˜';
        moodSpan.className = 'mood-icon';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = 'ì‚¼ì„±ì „ì í˜ë¥´ì†Œë‚˜';

        header.append(moodSpan, nameSpan);
      } else {
        header.textContent = 'ë‚˜';
      }

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;

      const meta = document.createElement('div');
      meta.className = 'message-meta';
      meta.textContent = asOf ? `ê¸°ì¤€ ì‹œê°: ${asOf}` : '';

      const viz = document.createElement('div');
      viz.className = 'visuals hidden';

      wrapper.append(header, bubble, meta, viz);
      messages.appendChild(wrapper);
      scrollToBottom();

      let chartInstances = [];

      const renderVisuals = async (data) => {
        if (!data) return;
        chartInstances.forEach((chart) => chart?.destroy?.());
        chartInstances = [];
        viz.innerHTML = '';
        viz.className = 'visuals';

        if (data.snapshot) {
          const grid = document.createElement('div');
          grid.className = 'snapshot-grid';

          if (data.snapshot.price) {
            const card = createSnapshotCard('ğŸ“Š ì‚¼ì„±ì „ì', data.snapshot.price);
            grid.appendChild(card);
          }
          if (data.snapshot.benchmark) {
            const card = createSnapshotCard('ğŸ§­ KOSPI', data.snapshot.benchmark);
            grid.appendChild(card);
          }

          if (grid.childElementCount) {
            viz.appendChild(grid);
          }
        }

        const hasHistory = Array.isArray(data.history) && data.history.length > 0;

        if (hasHistory) {
          const ChartJS = await waitForChart();
          if (ChartJS) {
            const canvas = document.createElement('canvas');
            canvas.width = 320;
            canvas.height = 220;
            viz.appendChild(canvas);

            const labels = data.history.map((row) => {
              const date = new Date(row.date);
              return Number.isNaN(date.getTime()) ? row.date : `${date.getMonth() + 1}/${date.getDate()}`;
            });
            const values = data.history.map((row) => row.close);

            const chart = new ChartJS(canvas, {
              type: 'line',
              data: {
                labels,
                datasets: [{
                  label: 'ì¢…ê°€ (ì›)',
                  data: values,
                  borderColor: '#38bdf8',
                  backgroundColor: 'rgba(56, 189, 248, 0.2)',
                  tension: 0.3,
                  fill: true,
                  pointRadius: 0,
                  borderWidth: 2
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: (ctx) => `${formatNumber(ctx.parsed.y)}ì›`
                    }
                  }
                },
                scales: {
                  x: {
                    grid: { display: false },
                    ticks: {
                      maxTicksLimit: 6,
                      color: 'rgba(148, 163, 184, 0.9)',
                      font: { size: 11, family: 'Pretendard, "Segoe UI", sans-serif' }
                    }
                  },
                  y: {
                    grid: { color: 'rgba(148, 163, 184, 0.2)' },
                    ticks: {
                      callback: (value) => `${formatNumber(value)}ì›`,
                      color: 'rgba(148, 163, 184, 0.9)',
                      font: { size: 12, family: 'Pretendard, "Segoe UI", sans-serif' }
                    }
                  }
                }
              }
            });
            chartInstances.push(chart);
          }
        }

        if (!viz.childElementCount) {
          const empty = document.createElement('div');
          empty.className = 'snapshot-sub';
          empty.textContent = 'ì‹œê°í™”í•  3ê°œì›” ê°€ê²© ë°ì´í„°ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.';
          viz.appendChild(empty);
        }
      };

      return {
        wrapper,
        header,
        bubble,
        meta,
        renderVisuals,
        setMood(value) {
          if (role !== 'ai') return;
          header.firstChild.textContent = value || 'ğŸ˜';
        },
        setText(value) {
          bubble.textContent = value;
        },
        appendText(value) {
          bubble.textContent += value;
        },
        setAsOf(value) {
          const pretty = formatAsOf(value);
          meta.textContent = pretty ? `ê¸°ì¤€ ì‹œê°: ${pretty}` : '';
        },
        renderVisuals
      };
    }

    function setLoading(isLoading) {
      const button = form.querySelector('button');
      button.disabled = isLoading;
      textarea.disabled = isLoading;
    }

    async function runStreaming(params) {
      const qs = new URLSearchParams(params).toString();
      const resp = await fetch(`/chat?${qs}`, { headers: { Accept: 'text/event-stream' } });
      if (!resp.ok || !resp.body) throw new Error('ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­ ì‹¤íŒ¨');

      const aiMessage = createMessage('ai', { text: '' });
      const reader = resp.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let buffer = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const events = buffer.split('\n\n');
        buffer = events.pop() ?? '';

        for (const raw of events) {
          if (!raw.startsWith('data:')) continue;
          const payload = raw.slice(5).trim();
          if (!payload) continue;
          const evt = JSON.parse(payload);
          if (evt.delta) aiMessage.appendText(evt.delta);
          if (evt.full) aiMessage.setText(evt.full);
          if (evt.asOf) aiMessage.setAsOf(evt.asOf);
          if (evt.visuals) aiMessage.renderVisuals(evt.visuals);
          if (evt.mood) {
            aiMessage.setMood(evt.mood);
            setMood(evt.mood);
            scheduleMoodRefresh();
          }
          if (evt.macro) {
            updateMacroPanel(evt.macro);
            scheduleMacroRefresh();
          }
        }
      }
    }

    async function runOnce(params) {
      params.stream = 'false';
      const qs = new URLSearchParams(params).toString();
      const resp = await fetch(`/chat?${qs}`);
      if (!resp.ok) throw new Error('ìš”ì²­ ì‹¤íŒ¨');
      const data = await resp.json();
      const aiMessage = createMessage('ai', { text: data.text || '(ì‘ë‹µ ì—†ìŒ)' });
      aiMessage.setAsOf(data.asOf);
      if (data.visuals) aiMessage.renderVisuals(data.visuals);
      if (data.mood) {
        aiMessage.setMood(data.mood);
        setMood(data.mood);
        scheduleMoodRefresh();
      }
      if (data.macro) {
        updateMacroPanel(data.macro);
        scheduleMacroRefresh();
      }
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(form);
      const question = formData.get('question')?.toString().trim();
      const ticker = formData.get('ticker')?.toString().trim() || '005930.KS';
      const stream = formData.get('stream') === 'on';

      if (!question) {
        alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      createMessage('user', { text: question });
      setLoading(true);

      try {
        const params = { ticker, q: question, stream: stream ? 'true' : 'false' };
        if (stream) {
          await runStreaming(params);
        } else {
          await runOnce(params);
        }
      } catch (err) {
        console.error(err);
        createMessage('ai', { text: `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´: ${err.message}` });
      } finally {
        setLoading(false);
        textarea.value = '';
        textarea.focus();
      }
    });

    document.querySelectorAll('.quick-asks button').forEach((btn) => {
      btn.addEventListener('click', () => {
        const question = btn.dataset.question;
        if (!question) return;
        textarea.value = question;
        textarea.focus();
      });
    });

    updateMacroPanel(null, { loading: true });
    loadMacroWeather();
    loadMoodSnapshot();
    textarea.focus();
  </script>
</body>
</html>

